%%%%===============UPDATE 13/09/2024=====================%%%
%%%%===============HỘP VD, VDEX 3 tùy chọn===============%%%%%
%%%%%%%%%%%%Môi trường EX, Bài tập đơn giản 1 tùy chọn sao=================%%%
\newcommand\circl[2][\mycolor]{\tikz[baseline=(char.base)]{\node[shape=circle,inner sep=1pt,draw=#1,fill=#1!20,text=#1!80!black,font=\bfseries\fontfamily{qag}\selectfont,minimum size=15pt] (char) {#2};
	}
}
\newcommand\circlenum[2][\mycolor]{\tikz[baseline=(char.base)]
	{\node[shape=circle,inner sep=1pt,fill=#1!20,text=#1!80!black,
		font=\footnotesize\bfseries\fontfamily{qag}\selectfont,minimum size=14pt,outer sep=0pt] (char) {#2};}}
\newcommand\circleTrue[2][\mycolor]{\tikz[baseline=(char.base)]{
		\node[shape=circle,inner sep=1pt,fill=#1!20,text=#1!80!black,
		font=\footnotesize\bfseries\fontfamily{qag}\selectfont,minimum size=14pt,outer sep=0pt] (char) {#2};}}
\usepackage{ex_test}
\usepackage{ifthen}
%%%===Điều khiển các phương án
%\renewcommand{\FalseEX}{\stepcounter{dapan}{{\circlenum{\Alph{dapan}}}}}
%\renewcommand{\TrueEX}{\stepcounter{dapan}{{\circlenum{\Alph{dapan}}}}}
\renewcommand{\FalseEX}{\stepcounter{dapan}{\fontsize{11.5pt}{3pt}\fontfamily{qag}\selectfont\textbf{\textcolor{\mycolor!90!black}{\Alph{dapan}\dotEX}}}}
\renewcommand{\TrueEX}{\stepcounter{dapan}{\fontsize{11.5pt}{3pt}\fontfamily{qag}\selectfont\textbf{\textcolor{\mycolor!90!black}{\Alph{dapan}\dotEX}}}}
%%%================Lệnh hình phải================%%%
%%%================Lệnh immini================%%%
\def\loaicau{}
\def\tieudehinh{}
\newlength{\widthPB}
\newboolean{TNdungsai}
\newcommand{\hinhphai}[2]{%
	\savebox{\imbox}{#2}%
	\tcbsidebyside[
	sidebyside adapt=right,
	blanker,sidebyside gap=5mm,
	sidebyside align=top seam,
	]{%
		{\tieudehinh}%
		#1
	}{%
		\usebox{\imbox}%
	}%
	%	\xdef\loaicau{\setboolean{TNdungsai}{false}}%
}

\renewcommand{\immini}[3][]{
	\savebox{\imbox}{#3}
	\setlength{\widthPB}{0.55\linewidth}
	\tcbsidebyside[
	sidebyside adapt=right,
	blanker,sidebyside gap=5mm,
	sidebyside align=top seam,
	]{%
		{\tieudehinh}#2
	}{%
		\usebox{\imbox}
	}
}


%%%%%%%%%%%%%%%%%%%%%%Tách lời giải%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\Newassociation{giaibth}{loigiaibth}{ansbth}
\Newassociation{giaiexh}{loigiaiexh}{ansexh}
\Newassociation{giaibt}{loigiaibt}{ansbt}
\Newassociation{giaiex}{loigiaiex}{ansex}
\NewTColorBox{ansbt}{m}{
	breakable,
	enhanced,
	outer arc=0pt,
	arc=0pt,
	colframe=white,
	frame hidden,
	left=-6pt,right=0pt,top=0pt,
	colback=white,
	attach boxed title to top left,
	boxed title style={
		colback=white,
		outer arc=0pt,
		arc=0pt,
		top=1pt,
		bottom=1pt,
		left=3pt,
		right=3pt,
		colframe=white
	},
	fonttitle=\bfseries\sffamily\selectfont\color{white},
	title={HDBT~#1},
	overlay unbroken and first={
		\path (title.north west) coordinate (A)
		($ (title.south west) +(-4pt,0pt)$) coordinate (B)
		(title.south east) coordinate (C)
		($ (title.north east)+(4pt,0) $) coordinate (D);
		\path[rounded corners=2pt,fill=\mycolor,
		preaction={transform canvas={shift={(-45:2pt)}},left color=\mycolor!45,right color=\mycolor!25}] 
		(A)--(B)--(C)--(D)--cycle;
		\path (A)--(C) node[midway,font=\color{white}\bfseries\sffamily\selectfont](Bai){\textsl{HDBT~#1}};
		\draw[rounded corners=2pt,thick,\mycolor] ([xshift=-3pt]B) coordinate (Bt)
		--([shift={(-2pt,2pt)}]A)--+(\linewidth,0) coordinate (Ct);
		\fill[\mycolor] (Bt) circle (1pt) (Ct) circle (2pt);
	}
}

\NewTColorBox{ansex}{m}{
	breakable,
	enhanced,
	outer arc=0pt,
	arc=0pt,
	colframe=white,
	frame hidden,
	left=-6pt,right=0pt,top=0pt,
	colback=white,
	attach boxed title to top left,
	boxed title style={
		colback=white,
		outer arc=0pt,
		arc=0pt,
		top=1pt,
		bottom=1pt,
		left=3pt,
		right=3pt,
		colframe=white
	},
	fonttitle=\bfseries\sffamily\selectfont\color{white},
	title={HD Câu~#1},
	overlay unbroken and first={
		\path (title.north west) coordinate (A)
		($ (title.south west) +(-4pt,0pt)$) coordinate (B)
		(title.south east) coordinate (C)
		($ (title.north east)+(4pt,0) $) coordinate (D);
		\path[rounded corners=2pt,fill=\mycolor,
		preaction={transform canvas={shift={(-45:2pt)}},left color=\mycolor!45,right color=\mycolor!25}] 
		(A)--(B)--(C)--(D)--cycle;
		\path (A)--(C) node[midway,font=\color{white}\bfseries\sffamily\selectfont](Bai){\textsl{HD Câu~#1}};
		\draw[rounded corners=2pt,thick,\mycolor] ([xshift=-3pt]B) coordinate (Bt)
		--([shift={(-2pt,2pt)}]A)--+(\linewidth,0) coordinate (Ct);
		\fill[\mycolor] (Bt) circle (1pt) (Ct) circle (2pt);
	}
}
\def\ansexhead{\begin{ansex}}
\def\ansexend{\end{ansex}}
\def\ansexheadH{\begin{ansex}}
\def\ansexendH{\end{ansex}}
\renewenvironment{loigiaibth}[1]{\begin{ansbt}{#1}}{\end{ansbt}}
\renewenvironment{loigiaiex}[1]{\ansexhead{#1}}{\ansexend}
\renewenvironment{loigiaiexh}[1]{\ansexheadH{#1}}{\ansexendH}
\def\luuloigiaibt{
	\AtBeginEnvironment{bt}{
		\renewcommand{\loigiai}[1]{%
		\end{btbox}
		\def\btend{}
		\scantokens{%
			\begin{giaibth}
				##1
			\end{giaibth}}
	}
}
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%HỘP CÂU CÓ 3 TÙY CHỌN%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%============Môi trường Câu hỏi=================%%%%%%%%
\def\checkmarkH{{\tikz[line join=miter]{\draw (0.5ex,0.5ex) coordinate (O) circle (0.75ex);\path[preaction={draw=white,line width=0.2ex},fill=white,draw] (0,.5ex) -- (.5ex,0) -- (1.5ex,1.35ex) -- (.45ex,.25ex) -- cycle; \draw ([shift={(90:0.75ex)}]O) arc (90:270:0.75ex);}} }

\makeatletter
\RenewDocumentEnvironment{ex}{+!O{}O{}}{%
\global\setbool{TNdungsai}{false}
\ifthenelse{\equal{#1}{c}}{
	% Xử lý khi #1 là "c" - giữ nguyên như cũ
	\ifblank{#2}{%
		\@ifnextchar\immini{\gdef\tieudehinh{{\bfseries\fontfamily{qag}\selectfont\color{\mycolor}\checkmarkH Câu \theex.\,}}}%
		{{\par\noindent{\bfseries\fontfamily{qag}\selectfont\color{\mycolor}\checkmarkH Câu \theex.\,}}}%
	}%
	{\@ifnextchar\immini{\gdef\tieudehinh{{\bfseries\fontfamily{qag}\selectfont\checkmarkH Câu \theex } {[\textit{#2}].\,}}}%
		{{\par\vspace*{1.5pt}\noindent\bfseries\fontfamily{qag}\selectfont\color{\mycolor}\checkmarkH Câu \theex} {\color{\mycolor}[\textit{#2}].\,}}}%
}{%
	\ifthenelse{\equal{#1}{s}}{%
		% Xử lý mới khi #1 là "s"
		\ifblank{#2}{%
			\@ifnextchar\immini{\gdef\tieudehinh{{\bfseries\fontfamily{qag}\selectfont\color{\mycolor} Câu \theex$^*$.\,}}}%
			{{\par\noindent{\bfseries\fontfamily{qag}\selectfont\color{\mycolor} Câu \theex$^*$.\,}}}%
		}%
		{\@ifnextchar\immini{\gdef\tieudehinh{{\bfseries\fontfamily{qag}\selectfont Câu \theex$^*$ } {[\textit{#2}].\,}}}%
			{{\par\vspace*{1.5pt}\noindent\bfseries\fontfamily{qag}\selectfont\color{\mycolor} Câu \theex$^*$} {\color{\mycolor}[\textit{#2}].\,}}}%
	}{%
		% Xử lý mặc định - giữ nguyên như cũ
		\ifblank{#2}{%
			\@ifnextchar\immini{\gdef\tieudehinh{{\bfseries\fontfamily{qag}\selectfont\color{\mycolor} Câu \theex.\,}}}%
			{{\par\noindent{\bfseries\fontfamily{qag}\selectfont\color{\mycolor} Câu \theex.\,}}}%
		}%
		{\@ifnextchar\immini{\gdef\tieudehinh{{\bfseries\fontfamily{qag}\selectfont Câu \theex } {[\textit{#2}].\,}}}%
			{{\par\vspace*{1.5pt}\noindent\bfseries\fontfamily{qag}\selectfont\color{\mycolor} Câu \theex} {\color{\mycolor}[\textit{#2}].\,}}}%
	}%
}
}{\gdef\tieudehinh{}\ignorespacesafterend}
\makeatother

\AtBeginEnvironment{ex}{%
\refstepcounter{ex}%
\setcounter{numTrue}{0}%
\setcounter{numTrueSol}{0}%
\global\setbool{TNdungsai}{false}%
\def\dotEX{.}%
\setcounter{numChoice}{0}%
\renewcommand{\loigiai}[1]{\gdef\tieudehinh{}\par\noindent%
	{\color{\maunhan!85!black}\reflectbox{\Large\WritingHand}\ {\fmmfamily\LARGE Lời giải.}} #1
	\ifthenelse{\value{numTrueSol}>0}{
		\hfill \textcolor{\maunhan}{\faKey~\circlenum[\maunhan]{\Alph{numTrueSol}}}
	}{}
}
%%%
\renewcommand{\shortans}[1]{%
	\scantokens{%
		\begin{giaiexh}
			#1
	\end{giaiexh}}%
	\phantom{.}\hfill{\raisebox{5pt}{\color{\mycolor!80!black}\faKey}\;\khungB{#1}}}%
%%
} 

%%%%%%%%%%%============Môi trường Bài tập=================%%%%%%%%
\newcounter{bt}
\makeatletter
\NewDocumentEnvironment{bt}{+!O{}O{}}{%
\refstepcounter{bt}%
\ifthenelse{\equal{#1}{c}}{
	% Xử lý khi #1 là "c" - giữ nguyên như cũ
	\ifblank{#2}{%
		\@ifnextchar\immini{\gdef\tieudehinh{{\bfseries\fontfamily{qag}\selectfont\color{\mycolor}\checkmarkH Bài \thebt.\,}}}%
		{{\par\noindent{\bfseries\fontfamily{qag}\selectfont\color{\mycolor}\checkmarkH Bài \thebt.\,}}}%
	}%
	{\@ifnextchar\immini{\gdef\tieudehinh{{\bfseries\fontfamily{qag}\selectfont\checkmarkH Bài \thebt } {[\textit{#2}].\,}}}%
		{{\par\vspace*{1.5pt}\noindent\bfseries\fontfamily{qag}\selectfont\color{\mycolor}\checkmarkH Bài \thebt} {\color{\mycolor}[\textit{#2}].\,}}}%
}{%
	\ifthenelse{\equal{#1}{s}}{%
		% Xử lý mới khi #1 là "s"
		\ifblank{#2}{%
			\@ifnextchar\immini{\gdef\tieudehinh{{\bfseries\fontfamily{qag}\selectfont\color{\mycolor} Bài \thebt$^*$.\,}}}%
			{{\par\noindent{\bfseries\fontfamily{qag}\selectfont\color{\mycolor} Bài \thebt$^*$.}}}%
		}%
		{\@ifnextchar\immini{\gdef\tieudehinh{{\bfseries\fontfamily{qag}\selectfont Bài \thebt$^*$ } {[\textit{#2}].\,}}}%
			{{\par\vspace*{1.5pt}\noindent\bfseries\fontfamily{qag}\selectfont\color{\mycolor} Bài \thebt$^*$} {\color{\mycolor}[\textit{#2}].\,}}}%
	}{%
		% Xử lý mặc định - giữ nguyên như cũ
		\ifblank{#2}{%
			\@ifnextchar\immini{\gdef\tieudehinh{{\bfseries\fontfamily{qag}\selectfont\color{\mycolor} Bài \thebt.\,}}}%
			{{\par\noindent{\bfseries\fontfamily{qag}\selectfont\color{\mycolor} Bài \thebt.\,}}}%
		}%
		{\@ifnextchar\immini{\gdef\tieudehinh{{\bfseries\fontfamily{qag}\selectfont Bài \thebt } {[\textit{#2}].\,}}}%
			{{\par\vspace*{1.5pt}\noindent\bfseries\fontfamily{qag}\selectfont\color{\mycolor} Bài \thebt} {\color{\mycolor}[\textit{#2}].\,}}}%
	}%
}
}{\gdef\tieudehinh{}\ignorespacesafterend}
\makeatother
\AtBeginEnvironment{bt}{%
	\renewcommand{\shortans}[1]{%
		\scantokens{%
			\begin{giaibt}
				#1
			\end{giaibt}}%
		\phantom{.}\hfill{\raisebox{5pt}{\color{\mycolor!80!black}\faKey}\;\khungB{#1}}}%
	\renewcommand{\loigiai}[1]{%
		\par\noindent%
		{\xdef\tieudehinh{}\par\noindent%
			{\color{\maunhan}\reflectbox{\Large\WritingHand}\ {\fmmfamily\LARGE Lời giải.}}%
			\par\noindent\ignorespaces
			#1
		}%
	}%
}
%%%=============Hộp ví dụ mẫu 3 tùy chọn =============
\newcounter{vd}
\NewTColorBox{vdbox}{+!O{}O{}O{}}{
enhanced,
fonttitle=\bfseries\sffamily\color{white},
title={\faGg\ Ví dụ~\thevd a},
colframe=white,
colback=white,
colbacktitle=white,
fonttitle=\bfseries,
coltitle=black,
code={\refstepcounter{vd}},
attach boxed title to top left=
{yshift=-2mm-\tcboxedtitleheight,yshifttext=2mm-\tcboxedtitleheight/2},
boxed title style={
	frame hidden,
	outer arc=0pt,
	arc=0pt,
	top=1pt,
	bottom=1pt,
	left=0pt,
	right=0pt
},
overlay unbroken and first={
	\path
	($ (title.north west) +(-2pt,0pt)$) coordinate (A)
	($ (title.south west) +(-2pt,3pt)$) coordinate (B)
	($ (title.south east)+(3pt,3pt) $) coordinate (C)
	($ (title.north east)+(3pt,0) $) coordinate (D)
	(intersection of C--B and frame.north east--frame.south east) coordinate (Et)
	(intersection of A--D and frame.north east--frame.south east) coordinate (Ft)
	($ (Et)-(4pt,0) $) coordinate (E)
	($(Ft)-(4pt,0)$) coordinate (F);
	\draw[line width=0.8pt,\mycolor!65!black,rounded corners=3pt] ($ (frame.north west) +(0,-2pt)$) rectangle (frame.south east);
	\path[fill=\mycolor!25,rounded corners=3pt]
	(A)--(B)--(E)--(F)--cycle;
	\path[fill=\mycolor!70!black,rounded corners=2pt]
	(A)--(B)--([xshift=3pt]C)--([xshift=3pt]D)--cycle;
	\path[left color=\mycolor,right color=\mycolor!80,rounded corners=3pt]
	([xshift=-2pt]A)--([xshift=-2pt]B)--(C)--(D)--cycle;
	
	\path ($ (A)!0.5!(B) +(2pt,0)$) node[anchor=west,font=\color{white}\bfseries\sffamily\selectfont]{{\faGg\ Ví dụ~\thevd}};
	
	\path ($ (C)!0.5!(D) +(4pt,0)$) node[anchor=west,font=\color{\mycolor!70!black}\itshape]{\textbf{#1}};
	\path ($ (E)!0.5!(F) +(-3pt,0)$) node[anchor=east,font=\color{\mycolor!70!black}\itshape\bfseries]{\taosao{#2}};
	\path ([shift={(-1pt,7pt)}]frame.south east) node[anchor=east,font=\fontsize{9.2 pt}{1pt}\selectfont\color{\mycolor!70!black}\itshape\bfseries]{#3};
},
top=\tcboxedtitleheight
}

\def\vdhead#1#2#3{\begin{vdbox}[#1][#2][#3]}
\def\vdend{\end{vdbox}}
\NewDocumentEnvironment{vd}{+!O{}O{}O{}}{%
\ifblank{#1}{\def\tuychonone{}}{\def\tuychonone{#1}}
\ifblank{#2}{\def\tuychontwo{0}}{\def\tuychontwo{#2}}
\ifblank{#3}{\def\tuychonthree{}}{\def\tuychonthree{#3}}
\vdhead{\tuychonone}{\tuychontwo}{\tuychonthree}
}{\vdend}
\AtBeginEnvironment{vd}{%
\global\setbool{TNdungsai}{false}%
\xdef\maudapanT{\mauphu!50!green}%
\xdef\maudapanF{\maunhan}%
\Opensolutionfile{ansbook}[Ansbook/Tam]%
\renewcommand{\loigiaiTF}{%
	\renewcommand{\loigiai}[1]{%
	\end{vdbox}
	\def\vdend{}
	\par\noindent%
	{\xdef\tieudehinh{}\par\noindent%
		{\color{\maunhan!85!black}\reflectbox{\Large\WritingHand}\ {\fmmfamily\LARGE Lời giải.}} ##1\hfill \textcolor{\maunhan}{\faKey}~\hspace*{-7pt}
		\ifbool{Ads}{\TLdung{A}}{\TLsai{A}}~\hspace*{-7pt}
		\ifbool{Bds}{\TLdung{B}}{\TLsai{B}}~\hspace*{-7pt}
		\ifbool{Cds}{\TLdung{C}}{\TLsai{C}}~\hspace*{-7pt}
		\ifbool{Dds}{\TLdung{D}}{\TLsai{D}}}
}%				
}
\ifbool{TNdungsai}{%
\renewcommand{\loigiai}[1]{%
\end{vdbox}
\def\vdend{}
\par\noindent%
{\xdef\tieudehinh{}\par\noindent%
	{\color{\maunhan}\reflectbox{\Large\WritingHand}\ {\fmmfamily\LARGE Lời giải.}} #1\hfill \textcolor{\maunhan}{\faKey}~\hspace*{-7pt}
	\ifbool{Ads}{\TLdung{A}}{\TLsai{A}}~\hspace*{-7pt}
	\ifbool{Bds}{\TLdung{B}}{\TLsai{B}}~\hspace*{-7pt}
	\ifbool{Cds}{\TLdung{C}}{\TLsai{C}}~\hspace*{-7pt}
	\ifbool{Dds}{\TLdung{D}}{\TLsai{D}}}
	}%
}{%
\renewcommand{\loigiai}[1]{
\end{vdbox}
\def\vdend{}
\gdef\tieudehinh{}\par\noindent%
{\color{\maunhan!85!black}\reflectbox{\Large\WritingHand}\ {\fmmfamily\LARGE Lời giải.}}\par\noindent\ignorespaces%
#1
\ifthenelse{\value{numTrueSol}>0}{%
\hfill {\color{\maunhan}\faKey~\circlenum[\maunhan]{\Alph{numTrueSol}}}%
}{}
}%
}%					
}
\AtEndEnvironment{vd}{\Closesolutionfile{ansbook}}

%%%==================Hộp vdex 3 tùy chọn==================%%%
\NewTColorBox{vdexbox}{+!O{}O{}O{}}{%
enhanced,
breakable,
left=6pt,
toprule at break=-\tcboxedtitleheight,
fonttitle=\bfseries\sffamily\color{white},
title={\faClockO\ Ví dụ~\thevd},
empty,opacityback=0,
colback=white,
colbacktitle=white,
fonttitle=\bfseries,
coltitle=black,
code={\refstepcounter{vd}},
attach boxed title to top left=
{yshift=-2mm-\tcboxedtitleheight,yshifttext=2mm-\tcboxedtitleheight/2},
boxed title style={
frame hidden,
outer arc=0pt,
arc=0pt,
top=3pt,
bottom=3pt,
left=0pt,
right=0pt
},
%%==Hộp không ngắt==%%
overlay unbroken ={
\path[draw=\mycolor,rounded corners=5pt, thick] (frame.north west) rectangle (frame.south east);
\path
($ (title.north west) +(-2pt,0pt)$) coordinate (A)
($ (title.south west) +(-2pt,3pt)$) coordinate (B)
($ (title.south east)+(3pt,3pt) $) coordinate (C)
($ (title.north east)+(3pt,0) $) coordinate (D)
(intersection of A--D and frame.north east--frame.south east) coordinate (E)
(intersection of B--C and frame.north east--frame.south east) coordinate (F)
;
%%==Phần thanh tiêu đề kéo dài==%%
\path[fill=\mycolor!15,rounded corners=3pt]
(A)--(B)--([xshift=-5pt]F) --([xshift=-5pt]E) --cycle;
%%==Phần bóng đổ bên phải tiêu đề ==%%
\path[fill=\mycolor!70!black,rounded corners=2pt]
(A)--(B)--([xshift=3pt]C)--([xshift=3pt]D)--cycle;
%%==Nền tiêu đề ==%%
\path[left color=\mycolor!80!black,right color=\mycolor,rounded corners=3pt]
([xshift=-2pt]A)--([xshift=-2pt]B)--(C)--(D)--cycle;
%%==Chữ VÍ DỤ ==%%
\path ($ (A)!0.5!(B) +(0pt,0)$) node[anchor=west,font=\color{white}\bfseries\sffamily\selectfont]{{\faClockO\ Ví dụ~\thevd}};
%%==Hiển thị sao==%%
\path ($ (C)!0.5!(D) +(9pt,0)$) node[anchor=west,font=\color{\mycolor}]{\taosao{#2}};
%%==Hiển thị điểm/ nguồn==%%
\path ($ (E)!0.5!(F) +(-9pt,0)$) node[anchor=east,font=\color{\mycolor!70!black}\itshape\bfseries]{#1};
%%==Hiển thị điểm/ nguồn==%%
\path ([shift={(-1pt,7pt)}]frame.south east) node[anchor=east,font=\fontsize{9.2 pt}{1pt}\selectfont\color{\mycolor!70!black}\itshape\bfseries]{#3};
},
%%==Phần đầu của hộp khi ngắt trang==%%
overlay first={
\path[draw=\mycolor,rounded corners=5pt, thick] (frame.south west) coordinate (FSW)
--(frame.north west) coordinate (FNW)
-- (frame.north east) coordinate (FNE)
--(frame.south east) coordinate (FSE)
(FSW)--(FSE)
;
\path
($ (title.north west) +(-2pt,0pt)$) coordinate (A)
($ (title.south west) +(-2pt,3pt)$) coordinate (B)
($ (title.south east)+(3pt,3pt) $) coordinate (C)
($ (title.north east)+(3pt,0) $) coordinate (D)
(intersection of A--D and frame.north east--frame.south east) coordinate (E)
(intersection of B--C and frame.north east--frame.south east) coordinate (F)
;
%%==Phần thanh tiêu đề kéo dài==%%
\path[fill=\mycolor!15,rounded corners=3pt]
(A)--(B)--([xshift=-5pt]F) --([xshift=-5pt]E) --cycle;
%%==Phần bóng đổ bên phải tiêu đề ==%%
\path[fill=\mycolor!70!black,rounded corners=2pt]
(A)--(B)--([xshift=3pt]C)--([xshift=3pt]D)--cycle;
%%==Nền tiêu đề ==%%
\path[left color=\mycolor!80!black,right color=\mycolor,rounded corners=3pt]
([xshift=-2pt]A)--([xshift=-2pt]B)--(C)--(D)--cycle;
%%==Chữ VÍ DỤ ==%%
\path ($ (A)!0.5!(B) +(0pt,0)$) node[anchor=west,font=\color{white}\bfseries\sffamily\selectfont]{{\faClockO\ Ví dụ~\thevd}};
%%==Hiển thị sao==%%
\path ($ (C)!0.5!(D) +(9pt,0)$) node[anchor=west,font=\color{\mycolor}]{\taosao{#2}};
%%==Hiển thị điểm/ nguồn==%%
\path ($ (E)!0.5!(F) +(-9pt,0)$) node[anchor=east,font=\color{\mycolor!70!black}\itshape\bfseries]{#1};
},
%%==Phần giữa của hộp khi ngắt trang==%%
overlay middle ={
frame code={yshifttext=\tcboxedtitleheight,
\path[draw=\mycolor,thick] (frame.north west) rectangle (frame.south east);
}
},
%%==Phần cuối của hộp khi ngắt trang==%%
overlay last ={
\path[draw=\mycolor,rounded corners=5pt, thick] (frame.north west) coordinate (FNW)-- (frame.south west) coordinate (FSW)
--(frame.south east) coordinate (FSE)--(frame.north east) coordinate (FNE)
(FNW)--(FNE)
;
\path ([shift={(-1pt,7pt)}]frame.south east) node[anchor=east,font=\fontsize{9.2 pt}{1pt}\selectfont\color{\mycolor!70!black}\itshape\bfseries]{#3};
},
top=\tcboxedtitleheight
}
\def\vdexhead#1#2#3{\begin{vdexbox}[#1][#2][#3]}
\def\vdexend{\end{vdexbox}}
\NewDocumentEnvironment{vdex}{+!O{}O{}O{}}{
\ifblank{#1}{\def\tuychonone{}}{\def\tuychonone{#1}}
\ifblank{#2}{\def\tuychontwo{0}}{\def\tuychontwo{#2}}
\ifblank{#3}{\def\tuychonthree{}}{\def\tuychonthree{#3}}
\vdexhead{\tuychonone}{\tuychontwo}{\tuychonthree}
}{\vdexend}
\AtBeginEnvironment{vdex}{%
\global\setbool{TNdungsai}{false}%
\xdef\maudapanT{\mauphu!50!green}%
\xdef\maudapanF{\maunhan}%
\Opensolutionfile{ansbook}[Ansbook/Tam]%
\renewcommand{\loigiaiTF}{%
\renewcommand{\loigiai}[1]{%
\end{vdexbox}
\def\vdexend{}
\par\noindent%
{\xdef\tieudehinh{}\par\noindent%
{\color{\maunhan!85!black}\reflectbox{\Large\WritingHand}\ {\fmmfamily\LARGE Lời giải.}} ##1\hfill \textcolor{\maunhan}{\faKey}~\hspace*{-7pt}
\ifbool{Ads}{\TLdung{A}}{\TLsai{A}}~\hspace*{-7pt}
\ifbool{Bds}{\TLdung{B}}{\TLsai{B}}~\hspace*{-7pt}
\ifbool{Cds}{\TLdung{C}}{\TLsai{C}}~\hspace*{-7pt}
\ifbool{Dds}{\TLdung{D}}{\TLsai{D}}}
}%				
}
\ifbool{TNdungsai}{%
\renewcommand{\loigiai}[1]{%
\end{vdexbox}
\def\vdexend{}
\par\noindent%
{\xdef\tieudehinh{}\par\noindent%
{\color{\maunhan}\reflectbox{\Large\WritingHand}\ {\fmmfamily\LARGE Lời giải.}} #1\hfill \textcolor{\maunhan}{\faKey}~\hspace*{-7pt}
\ifbool{Ads}{\TLdung{A}}{\TLsai{A}}~\hspace*{-7pt}
\ifbool{Bds}{\TLdung{B}}{\TLsai{B}}~\hspace*{-7pt}
\ifbool{Cds}{\TLdung{C}}{\TLsai{C}}~\hspace*{-7pt}
\ifbool{Dds}{\TLdung{D}}{\TLsai{D}}}
}%
}{%
\renewcommand{\loigiai}[1]{
\end{vdexbox}
\def\vdexend{}
\gdef\tieudehinh{}\par\noindent%
{\color{\maunhan!85!black}\reflectbox{\Large\WritingHand}\ {\fmmfamily\LARGE Lời giải.}}\par\noindent\ignorespaces%
#1
\ifthenelse{\value{numTrueSol}>0}{%
\hfill {\color{\maunhan}\faKey~\circlenum[\maunhan]{\Alph{numTrueSol}}}%
}{}}%
}%					
}
\AtEndEnvironment{vdex}{\Closesolutionfile{ansbook}}
%%%=======================Một số lệnh mới================================%%%
%%%===============Câu trả lời ngắn=======================%%%
\tikzset{
master/.style={
execute at end picture={
\coordinate (lower right) at (current bounding box.south east);
\coordinate (upper left) at (current bounding box.north west);
}
},
slave/.style={
execute at end picture={
\pgfresetboundingbox
\path (upper left) rectangle (lower right);
}
}
}



\newcommand{\ovuong}[2][2.5]{%
%\scantokens{%
%\begin{giaibt}
%#2
%\end{giaibt}}% 
{\linepenalty100\exhyphenpenalty0
{\tikz{%
\path (0,0) node[text width= #1cm,inner sep=3pt,align=center,minimum height=0.65cm,minimum width=#1 cm+0.1cm] (char) {#2};
\draw[rounded corners=2pt,thick,\maunhan] (char.north west) rectangle (char.south east);
}\hspace*{-9pt}%
}%
}}

%\newcommand{\shortans}[2][2.5]{%
%\ovuong[#1]{#2}%
%}
\newcommand{\shortans}[1]{%
	\khungB{#1}%
}

\RenewEnviron{loigiaibt}[1]{%
\tikz{\node[rounded corners,draw=\maunhan,text width=4cm,align=center,minimum height=19pt] 
{\textbf{Bài~#1.} {\boldmath\textbf{\color{\maunhan}\BODY}}}%
}
}%

%%%#####==================Tùy chỉnh lời giải ========================########%%%

%\gdef\tieudehinh{}\par\noindent%
%{\color{\maunhan!85!black}\reflectbox{\Large\WritingHand}\ {\fmmfamily\LARGE Lời giải.}}
%\fontfamily{qzc}\selectfont Lời giải.
%%\fmmfamily\LARGE Lời giải.
\def\hienthiloigiai{%
\global\setbool{TNdungsai}{false}%
\xdef\maudapanT{\mauphu!50!green}%
\xdef\maudapanF{\maunhan}%
\AtBeginEnvironment{ex}{%
\renewcommand{\loigiaiTF}{%
\renewcommand{\loigiai}[1]{%
\par\noindent%
{\xdef\tieudehinh{}\par\noindent%
{\color{\maunhan!85!black}\reflectbox{\Large\WritingHand}\ {\fmmfamily\LARGE Lời giải.}} ####1\hfill \textcolor{\maunhan}{\faKey}~\hspace*{-7pt}
\ifbool{Ads}{\TLdung{A}}{\TLsai{A}}~\hspace*{-7pt}
\ifbool{Bds}{\TLdung{B}}{\TLsai{B}}~\hspace*{-7pt}
\ifbool{Cds}{\TLdung{C}}{\TLsai{C}}~\hspace*{-7pt}
\ifbool{Dds}{\TLdung{D}}{\TLsai{D}}}
}%				
}
\renewcommand{\shortans}[1]{
\scantokens{%
\begin{giaiexh}
##1
\end{giaiexh}}%
\phantom{.}\hfill{\color{\maunhan!85!black}\raisebox{6pt}{\faKey}}\;\khungB{##1}
}%
\ifbool{TNdungsai}{%
\renewcommand{\loigiai}[1]{%
\par\noindent%
{\xdef\tieudehinh{}\par\noindent%
{\color{\maunhan}\reflectbox{\Large\WritingHand}\ {\fmmfamily\LARGE Lời giải.}} ##1\hfill \textcolor{\maunhan}{\faKey}~\hspace*{-7pt}
\ifbool{Ads}{\TLdung{A}}{\TLsai{A}}~\hspace*{-7pt}
\ifbool{Bds}{\TLdung{B}}{\TLsai{B}}~\hspace*{-7pt}
\ifbool{Cds}{\TLdung{C}}{\TLsai{C}}~\hspace*{-7pt}
\ifbool{Dds}{\TLdung{D}}{\TLsai{D}}}
}%
}{%
\renewcommand{\loigiai}[1]{\gdef\tieudehinh{}\par\noindent%
{\color{\maunhan!85!black}\reflectbox{\Large\WritingHand}\ {\fmmfamily\LARGE Lời giải.}}\par\noindent\ignorespaces%
##1
\ifthenelse{\value{numTrueSol}>0}{%
\hfill {\color{\maunhan}\faKey~\circlenum[\maunhan]{\Alph{numTrueSol}}}%
}{}}%
}%					
}

%%%
\AtBeginEnvironment{bt}{%
	\renewcommand{\shortans}[1]{%
		\scantokens{%
			\begin{giaibt}
				##1
		\end{giaibt}}%
		\phantom{.}\hfill{\raisebox{5pt}{\color{\mycolor!80!black}\faKey}\;\khungB{##1}}}%
	\renewcommand{\loigiai}[1]{%
		\par\noindent%
		{\xdef\tieudehinh{}\par\noindent%
			{\color{\maunhan}\reflectbox{\Large\WritingHand}\ {\fmmfamily\LARGE Lời giải.}}%
			\par\noindent\ignorespaces
			##1
		}%
	}%
}

%%%
\AtBeginEnvironment{vdex}{%
\renewcommand{\loigiaiTF}{%
\renewcommand{\loigiai}[1]{%
\end{vdexbox}
\def\vdexend{}
\par\noindent%
{\xdef\tieudehinh{}\par\noindent%
{\color{\maunhan!85!black}\reflectbox{\Large\WritingHand}\ {\fmmfamily\LARGE Lời giải.}} ####1\hfill \textcolor{\maunhan}{\faKey}~\hspace*{-7pt}
\ifbool{Ads}{\TLdung{A}}{\TLsai{A}}~\hspace*{-7pt}
\ifbool{Bds}{\TLdung{B}}{\TLsai{B}}~\hspace*{-7pt}
\ifbool{Cds}{\TLdung{C}}{\TLsai{C}}~\hspace*{-7pt}
\ifbool{Dds}{\TLdung{D}}{\TLsai{D}}}
}%				
}
\renewcommand{\shortans}[2][]{\phantom{.}\hfill{\color{\maunhan!85!black}\raisebox{6pt}{\faKey}}\;\khungB{##2}}
\ifbool{TNdungsai}{%
\renewcommand{\loigiai}[1]{%
\end{vdexbox}
\def\vdexend{}
\par\noindent%
{\xdef\tieudehinh{}\par\noindent%
{\color{\maunhan}\reflectbox{\Large\WritingHand}\ {\fmmfamily\LARGE Lời giải.}} ##1\hfill \textcolor{\maunhan}{\faKey}~\hspace*{-7pt}
\ifbool{Ads}{\TLdung{A}}{\TLsai{A}}~\hspace*{-7pt}
\ifbool{Bds}{\TLdung{B}}{\TLsai{B}}~\hspace*{-7pt}
\ifbool{Cds}{\TLdung{C}}{\TLsai{C}}~\hspace*{-7pt}
\ifbool{Dds}{\TLdung{D}}{\TLsai{D}}}
}%
}{%
\renewcommand{\loigiai}[1]{%
\end{vdexbox}
\def\vdexend{}
\gdef\tieudehinh{}\par\noindent%
{\color{\maunhan!85!black}\reflectbox{\Large\WritingHand}\ {\fmmfamily\LARGE Lời giải.}}\par\noindent\ignorespaces%
##1
\ifthenelse{\value{numTrueSol}>0}{%
\hfill {\color{\maunhan}\faKey~\circlenum[\maunhan]{\Alph{numTrueSol}}}%
}{}}%
}%					
}
%%
\AtBeginEnvironment{vd}{
\renewcommand{\loigiai}[1]{%
\end{vdbox}
\def\vdend{}
\gdef\tieudehinh{}\par\noindent%
{\color{\maunhan!85!black}\reflectbox{\Large\WritingHand}\ {\fmmfamily\LARGE Lời giải.}}\par\noindent\ignorespaces%
##1
\ifthenelse{\value{numTrueSol}>0}{%
\hfill {\color{\maunhan}\faKey~\circlenum[\maunhan]{\Alph{numTrueSol}}}%
}{}
}%
}				
}
%%%=============lưu lời giải =============%%%
\def\luuloigiai{
\AtBeginEnvironment{ex}{%
\xdef\maudapanT{\maunen}%
\xdef\maudapanF{\maunen}%
\renewcommand{\loigiaiTF}{}
\renewcommand{\loigiai}[1]{%
\Writetofile{ansex}{\string\def\string\writeANS{\string\faKey\, \saveans}}
\ifbool{TNdungsai}{}{\Writetofile{ansex}{\string\def\string\writeANS{\string\faKey\, \circlenum{\Alph{numTrueSol}}}}}
\scantokens{%
\begin{giaiex}
##1
\end{giaiex}
}% 
}
%%%
\renewcommand{\shortans}[1]{% 
	\scantokens{%
		\begin{giaiexh}
			##1
		\end{giaiexh}
	}% 
%	\phantom{.}\hfill{\raisebox{5pt}{\color{\mycolor!80!black}\faKey}\;\khungB{}}
}%
%%%
}
\AtBeginEnvironment{bt}{%

\renewcommand{\shortans}[1]{% 
\scantokens{%
\begin{giaibt}
##1
\end{giaibt}
}% 
%\phantom{.}\hfill{\raisebox{5pt}{\color{\mycolor!80!black}\faKey}\;\khungB{}}
}%
\renewcommand{\loigiai}[1]{%
\Writetofile{ansbth}{\string\def\string\writeANS{}}
\scantokens{%
\begin{giaibth}
##1
\end{giaibth}
}% 
}
}
}

%%%================tắt lời giải trắc nghiệm================%%%
\def\tatloigiai{
\AtBeginEnvironment{ex}{%
\xdef\maudapanT{\maunen}%
\xdef\maudapanF{\maunen}%
	\renewcommand{\shortans}[1]{%
	\scantokens{%
		\begin{giaiexh}
			##1
	\end{giaiexh}}%
	%\phantom{.}\hfill{\color{\maunhan}\raisebox{6pt}{\faKey}}\;\khungB{}
	}%
\renewcommand{\loigiaiTF}{}
\renewcommand{\loigiai}[1]{}
}

\AtBeginEnvironment{bt}{%
\renewcommand{\shortans}[1]{%
\scantokens{%
\begin{giaibt}
##1
\end{giaibt}}%
%\phantom{.}\hfill{\color{\maunhan}\raisebox{6pt}{\faKey}}\;\khungB{}
}%
\renewcommand{\loigiaiTF}{}
\renewcommand{\loigiai}[1]{}
}
\AtBeginEnvironment{vdex}{%
\xdef\maudapanT{\maunen}%
\xdef\maudapanF{\maunen}%
\renewcommand{\loigiaiTF}{}
\renewcommand{\loigiai}[1]{}
}
\AtBeginEnvironment{vd}{%
\xdef\maudapanT{\maunen}%
\xdef\maudapanF{\maunen}%
\renewcommand{\loigiaiTF}{}
\renewcommand{\loigiai}[1]{}
}
}
%%%=====================Đổi thành dòng kẻ=======================%%%

\def\dongkeloigiai{
	\AtBeginEnvironment{ex}{%
		\xdef\maudapanT{\maunen}
		\xdef\maudapanF{\maunen}
		\renewcommand{\shortans}[1]{%
			\scantokens{%
				\begin{giaiexh}
					##1
				\end{giaiexh}}%
			\phantom{.}\hfill{\raisebox{5pt}{\color{\mycolor!80!black}\faKey}\;\khungB{}}
		}%
		\renewcommand{\loigiaiTF}{}
		\renewcommand{\loigiai}[1]{%
		\DoiThanhDongKe{##1}
		}
	}
\AtBeginEnvironment{bt}{
	\renewcommand{\shortans}[1]{%
	\scantokens{%
	\begin{giaibt}
	##1
	\end{giaibt}}%
%	\phantom{.}\hfill{\raisebox{5pt}{\color{\mycolor!80!black}\faKey}\;\khungB{}}
	}%
	\renewcommand{\loigiaiTF}{}
	\renewcommand{\loigiai}[1]{%
	\DoiThanhDongKe{##1}
	}
}
\AtBeginEnvironment{vd}{
\xdef\maudapanT{\maunen}
\xdef\maudapanF{\maunen}
\renewcommand{\loigiaiTF}{}
\renewcommand{\loigiai}[1]{%
\end{vdbox}
\def\vdend{}
\DoiThanhDongKe{##1}
}
}
\AtBeginEnvironment{vdex}{
\xdef\maudapanT{\maunen}
\xdef\maudapanF{\maunen}
\renewcommand{\loigiaiTF}{}
\renewcommand{\loigiai}[1]{%
\end{vdexbox}
\def\vdexend{}
\DoiThanhDongKe{##1}
}
}
}
%%%=============================================%%%
\def\dongkeHaicot{
\AtBeginEnvironment{ex}{
\xdef\maudapanT{\maunen}
\xdef\maudapanF{\maunen}
\renewcommand{\shortans}[1]{%
\scantokens{%
\begin{giaibt}
##1
\end{giaibt}}%
\phantom{.}\hfill{\raisebox{5pt}{\color{\mycolor!80!black}\faKey}\;\khungB{}}}%
\renewcommand{\loigiaiTF}{}
\renewcommand{\loigiai}[1]{
\begin{multicols}{2}			
\DoiThanhDongKeH{##1}
\end{multicols}%
}
}
\AtBeginEnvironment{bt}{
\xdef\maudapanT{\maunen}
\xdef\maudapanF{\maunen}
\renewcommand{\loigiaiTF}{}
\renewcommand{\loigiai}[1]{
\begin{multicols}{2}			
\DoiThanhDongKeH{##1}
\end{multicols}%
}
}	
\AtBeginEnvironment{vd}{
\xdef\maudapanT{\maunen}
\xdef\maudapanF{\maunen}
\renewcommand{\loigiaiTF}{}
\renewcommand{\loigiai}[1]{
\end{vdbox}
\def\vdend{}
\begin{multicols}{2}			
\DoiThanhDongKeH{##1}
\end{multicols}%
}
}	
\AtBeginEnvironment{vdex}{
\xdef\maudapanT{\maunen}
\xdef\maudapanF{\maunen}
\renewcommand{\loigiaiTF}{}
\renewcommand{\loigiai}[1]{
\end{vdexbox}
\def\vdexend{}
\begin{multicols}{2}			
\DoiThanhDongKeH{##1}
\end{multicols}%
}
}	
}

\newcommand{\Pointilles}[2][1.1]{%
\par\nobreak
\noindent\rule{0pt}{1.1\baselineskip}%
\foreach \i in {1,...,#2}{%
\ifnum\i=1
\noindent\makebox[\linewidth]{\rule{0pt}{#1\baselineskip}\reflectbox{\color{\maunhan}\Large\WritingHand}\ {\color{\maunhan} \fmmfamily\LARGE Bài làm:}\dotfill}\endgraf
\else
\noindent\makebox[\linewidth]{\rule{0pt}{#1\baselineskip}\dotfill}\endgraf
\fi
}
}

\newcommand{\DoiThanhDongKe}[1]{
\setbox0=\vbox{\hbox{
\noindent\begin{minipage}{\linewidth}%
#1 aaaaa
\end{minipage}
}}
\linepar=\ht0
\pgfmathparse{int((\linepar-\fboxsep)/(\lineheight)+1)}
\ifnum\pgfmathresult>3
\noindent%
\Pointilles{\pgfmathresult}
\else
\noindent%
\Pointilles{3}
\fi
}

\newcommand{\DoiThanhDongKeH}[1]{
\setbox0=\vbox{\hbox{
\noindent\begin{minipage}{\linewidth}%
#1 aaaaa
\end{minipage}
}}
\linepar=\ht0
\pgfmathparse{int((\linepar-\fboxsep)/(0.85\lineheight)+1)}
\ifnum\pgfmathresult>3
\noindent%
\Pointilles{\pgfmathresult}
\else
\noindent%
\Pointilles{4}
\fi
}
%%%==================Tạo ô li===========================%%%
\newcommand{\DoiThanhOly}[2][\mycolor]{
\setbox0=\vbox{\hbox{
\noindent\begin{minipage}{\linewidth}%
#1 aaaaa
\end{minipage}
}}
\linepar=\ht0
\pgfmathparse{int((\linepar-\fboxsep)/(\lineheight)+1)}
\let\mydong\pgfmathresult	\ifnum\pgfmathresult>3
\begin{center}
\foreach \i in {0,1,...,\mydong}{%
\begin{tikzpicture}
\draw[#1!25,ultra thin,step=0.2] (0,0) grid +(17,1);
\draw[#1!65] (0,0) grid +(17,1);
\end{tikzpicture}\\[-1.1pt]
}
\end{center}
\else
\noindent%
\begin{center}
\begin{tikzpicture}
\draw[#1!25,ultra thin,step=0.2] (0,0) grid +(17,3);
\draw[#1!65] (0,0) grid +(17,3);
\end{tikzpicture}
\end{center}
\fi
}
\def\dongkeOly{
\AtBeginEnvironment{ex}{%
\renewcommand{\loigiai}[1]{%
\DoiThanhOly{##1}%
}
}
\AtBeginEnvironment{exsao}{
\renewcommand{\loigiai}[1]{%
\DoiThanhOly{##1}
}
}

\AtBeginEnvironment{bt}{
\renewcommand{\loigiai}[1]{
\DoiThanhOly{##1}
}
}
\AtBeginEnvironment{btsao}{
\renewcommand{\loigiai}[1]{
\DoiThanhOly{##1}
}
}

\AtBeginEnvironment{vd}{
\renewcommand{\loigiai}[1]{
\DoiThanhOly{##1}
}
}
\AtBeginEnvironment{vdsao}{
\renewcommand{\loigiai}[1]{
\DoiThanhOly{##1}
}
}
}

\def\luuloigiaiex{
\AtBeginEnvironment{ex}{
\setboolean{TNdungsai}{false}%
\gdef\loaicau{\setboolean{TNdungsai}{false}}%
\renewcommand{\loigiai}[1]{%
\ifthenelse{\boolean{TNdungsai}}{%Câu hỏi trắc nghiệm đúng sai
\scantokens{%
\begin{giaiex}
##1
\phantom{a}\hfill{{\faKey}~ 
\ifbool{Ads}{\TLdung{A}}{\TLsai{A}}~
\ifbool{Bds}{\TLdung{B}}{\TLsai{B}}~
\ifbool{Cds}{\TLdung{C}}{\TLsai{C}}~
\ifbool{Dds}{\TLdung{D}}{\TLsai{D}} 
}%
\end{giaiex}}
\Writetofile{ansbook}{\string\def\string\writeANS{\saveans}}
\scantokens{
\begin{solbook}
\writeANS
\end{solbook}
}%
}{%Câu hỏi trắc nghiệm 1 phương án
\ifnum\the\value{numTrue}=1
\scantokens{%
\begin{giaiex}
##1
\phantom{a}\hfill{ \faKey~\circlenum{A}}
\end{giaiex}}
\fi%
\ifnum\the\value{numTrue}=2
\scantokens{%
\begin{giaiex}
##1
\phantom{a}\hfill{ \faKey~\circlenum{B}}
\end{giaiex}}
\fi%	 
\ifnum\the\value{numTrue}=3
\scantokens{%
\begin{giaiex}
##1
\phantom{a}\hfill{ \faKey~\circlenum{C}}
\end{giaiex}}
\fi %	 
\ifnum\the\value{numTrue}=4
\scantokens{%
\begin{giaiex}
##1
\phantom{a}\hfill{ \faKey~\circlenum{D}}
\end{giaiex}}
\fi\vspace*{-3pt}%
} 
}
}
}

%%%==============Tạo số dòng kẻ như mong muốn =====================%%%

\newcommand{\sodongke}[2][5]{%
\AtBeginEnvironment{#2}{%
\renewcommand{\loigiai}[1]{%
\Pointilles{#1}
}
}
}

\newcommand{\sodongkeH}[2][5]{%
\AtBeginEnvironment{#2}{%
\renewcommand{\loigiai}[1]{%
\end{#2box}%
\expandafter\def\csname#2end\endcsname{}%
\Pointilles{#1}%
}%
}%
}


\usepackage{xstring}
\newcommand{\khungB}[1]{%
\StrSubstitute{#1}{$}{}[\chuoi] % Loại bỏ dấu $
\StrLen{\chuoi}[\strlen]%
\ifnum\strlen<4
\def\strlen{4}
\fi
\foreach \i in {1,...,\strlen} {%
\StrChar{\chuoi}{\i}[\char]%
\tikz\node[draw=\mycolor!65,rectangle,minimum width=19pt,minimum height=19pt,rounded corners=0pt,text=black]{\char};%
}%
}

%%%===============trắc nghiệm đúng sai======================%%%
\usepackage{multicol}
\setlength{\columnseprule}{0pt}
\setlength{\columnsep}{1cm}
\setlength{\extrarowheight}{4pt}
\def\columnseprulecolor{\color{\maunhan}}
%%%%%%%%%%%%%
\usepackage{array}% dùng căn lề các mảng
\usepackage{multirow}% gop các dòng
\usepackage{makecell}% chỉnh định dạng các ô
\usepackage{booktabs}% Chèn các đường kẻ trên và dưới
\usepackage{diagbox}
\usepackage{longtable}
\renewcommand{\arraystretch}{1.2}% giãn độ rộng của dòng
\newcolumntype{L}[1]{>{\raggedright\let
\newline\\\arraybackslash\hspace{0pt}}p{#1}}
\newcolumntype{C}[1]{>{\centering\let
\newline\\\arraybackslash\hspace{0pt}}p{#1}}
\newcolumntype{R}[1]{>{\raggedleft\let
\newline\\\arraybackslash\hspace{0pt}}p{#1}}
\setlength{\tabcolsep}{5pt} % giãn độ rộng của cột
\setlength{\aboverulesep}{4pt} 
\setlength{\belowrulesep}{4pt}
\arrayrulecolor{\mycolor!80!black} 
\setlength\arrayrulewidth{1pt}

\newbool{Ads}
\newbool{Bds}
\newbool{Cds}
\newbool{Dds}
\makeatletter
\newcommand{\KiemtraA}{\@ifnextchar\True{\global\setbool{Ads}{true}\xdef\saveans{\saveans\string\TLdung{A}}}{\global\setbool{Ads}{false}\xdef\saveans{\saveans\string\TLsai{A}}}}
\newcommand{\KiemtraB}{\@ifnextchar\True{\global\setbool{Bds}{true}\xdef\saveans{\saveans\string\TLdung{B}}}{\global\setbool{Bds}{false}\xdef\saveans{\saveans\string\TLsai{B}}}}
\newcommand{\KiemtraC}{\@ifnextchar\True{\global\setbool{Cds}{true}\xdef\saveans{\saveans\string\TLdung{C}}}{\global\setbool{Cds}{false}\xdef\saveans{\saveans\string\TLsai{C}}}}
\newcommand{\KiemtraD}{\@ifnextchar\True{\global\setbool{Dds}{true}\xdef\saveans{\saveans\string\TLdung{D}}}{\global\setbool{Dds}{false}\xdef\saveans{\saveans\string\TLsai{D}}}}
\makeatother


\def\saveans{}
\newlength{\widthNPB}
\setlength{\widthPB}{1.07\linewidth}
\setlength{\widthNPB}{0.53\linewidth-1.1cm}
\setlength\LTpre{5pt}% khoảng cách trước longtable
\setlength\LTpost{3pt}
\def\maudapanT{\mauphu!50!green}
\def\maudapanF{\maunhan}
\newcommand{\choiceTF}[5][1]{%
\def\saveans{}%
\global\setbool{TNdungsai}{true}%
\loigiaiTF
\ifthenelse{\equal{#1}{1}}{%
\begin{enumerate}[wide=\parindent,label*=\protect{\alph*)},itemsep=-3pt,topsep=-4pt]
\item \KiemtraA#2\dotEX	
\item \KiemtraB#3\dotEX
\item \KiemtraC#4\dotEX
\item \KiemtraD#5\dotEX
\end{enumerate}
}{
\ifthenelse{\equal{#1}{t}}{%
\begin{longtable}{|p{\widthPB}|C{0.45cm}|C{.45cm}|}
\hline \rowcolor{\mycolor!20}
\thead{\normalsize\sffamily\bfseries\fontfamily{qag}\selectfont Phát biểu}& {\bfseries\fontfamily{qag}\selectfont Đ} & {\bfseries\fontfamily{qag}\selectfont S}\\
\hline
{a)} \KiemtraA#2\dotEX &\ifbool{Ads}{{\color{\maudapanT}\footnotesize\faCheck}}{} &\ifbool{Ads}{}{{\color{\maudapanF}\footnotesize\faClose}}  \\
\hline
{b)} \KiemtraB#3\dotEX & \ifbool{Bds}{{\color{\maudapanT}\footnotesize\faCheck}}{} & \ifbool{Bds}{}{{\color{\maudapanF}\footnotesize\faClose}}\\
\hline
{c)} \KiemtraC#4\dotEX &\ifbool{Cds}{{\color{\maudapanT}\footnotesize\faCheck}}{} &\ifbool{Cds}{}{{\color{\maudapanF}\footnotesize\faClose}} \\
\hline
{d)} \KiemtraD#5\dotEX & \ifbool{Dds}{{\color{\maudapanT}\footnotesize\faCheck}}{} & \ifbool{Dds}{}{{\color{\maudapanF}\footnotesize\faClose}} \\
\hline
\end{longtable}
}{%
\ifthenelse{\equal{#1}{tt}}{%
\begin{center}
\vspace*{-0.65\baselineskip}
\begin{tabular}{cc}%
\begin{tabular}[t]{|p{\widthNPB}|C{0.45cm}|C{.45cm}|}
\hline\rowcolor{\mycolor!20}
\thead{\normalsize\sffamily\bfseries\fontfamily{qag}\selectfont Phát biểu}& {\bfseries\fontfamily{qag}\selectfont Đ} & {\bfseries\fontfamily{qag}\selectfont S}\\
\hline
{a)} \KiemtraA#2\dotEX &\ifbool{Ads}{{\color{\maudapanT}\footnotesize\faCheck}}{} &\ifbool{Ads}{}{{\color{\maudapanF}\footnotesize\faClose}}  \\
\hline
{b)} \KiemtraB#3\dotEX &\ifbool{Bds}{{\color{\maudapanT}\footnotesize\faCheck}}{} &\ifbool{Bds}{}{{\color{\maudapanF}\footnotesize\faClose}}  \\
\hline
\end{tabular}~
\begin{tabular}[t]{|p{\widthNPB}|C{0.35cm}|C{.35cm}|}
\hline \rowcolor{\mycolor!20}
\thead{\normalsize\sffamily\bfseries\fontfamily{qag}\selectfont Phát biểu}& {\bfseries\fontfamily{qag}\selectfont Đ} & {\bfseries\fontfamily{qag}\selectfont S}\\
\hline
{c)} \KiemtraC#4\dotEX &\ifbool{Cds}{{\color{\maudapanT}\footnotesize\faCheck}}{} &\ifbool{Cds}{}{{\color{\maudapanF}\footnotesize\faClose}}  \\
\hline
{d)} \KiemtraD#5\dotEX &\ifbool{Dds}{{\color{\maudapanT}\footnotesize\faCheck}}{} &\ifbool{Dds}{}{{\color{\maudapanF}\footnotesize\faClose}}  \\
\hline
\end{tabular}
\end{tabular}
\end{center}
}{
\begin{multicols}{#1}
\begin{enumerate}[wide=0.65cm,label*=\protect{\alph*)},itemsep=-3pt,topsep=-4pt]
\item \KiemtraA#2\dotEX	
\item \KiemtraB#3\dotEX
\item \KiemtraC#4\dotEX
\item \KiemtraD#5\dotEX
\end{enumerate}
\end{multicols}	
}
}
}
\Writetofile{ansbook}{\string\def\string\writeANS{\saveans}}
\scantokens{
\begin{solbook}
\writeANS
\end{solbook}
}%
\setcounter{numTrue}{0}%
}

\newcommand{\TLdung}[1]{%
\tikz[baseline=(char.base)]
{\node[shape=circle,inner sep=0.5pt,draw=\mauphu,
font=\bfseries\footnotesize,text=\mauphu,minimum size=12pt,outer sep=0pt] (char) {#1};
\path (char) node[text=\mauphu!65!green,anchor=center]{{\footnotesize\faCheck}};
}\ignorespaces}

\newcommand{\TLsai}[1]{%
\tikz[baseline=(char.base)]
{\node[shape=circle,inner sep=0.5pt,draw=\maunhan,font=\bfseries\footnotesize,text=\maunhan!60!black,minimum size=12pt,outer sep=0pt] (char) {#1};
\path (char) node[text=\maunhan!30!red,anchor=center]{\footnotesize\faTimes};
}\ignorespaces}
\def\checkmarkH{{\tikz[line join=miter]{\draw (0.5ex,0.5ex) coordinate (O) circle (0.75ex);\path[preaction={draw=white,line width=0.2ex},fill=white,draw] (0,.5ex) -- (.5ex,0) -- (1.5ex,1.35ex) -- (.45ex,.25ex) -- cycle; \draw ([shift={(90:0.75ex)}]O) arc (90:270:0.75ex);}} }


\newcommand{\loigiaiTF}{
\renewcommand{\loigiai}[1]{%
\par\noindent%
{\xdef\tieudehinh{}{\color{\maunhan}\reflectbox{\Large\WritingHand}\ {\color{\maunhan}\fmmfamily\LARGE Lời giải.}} ##1\hfill \textcolor{\maunhan}{\faKey}~\hspace*{-7pt}
\ifbool{Ads}{\TLdung{A}}{\TLsai{A}}~\hspace*{-7pt}
\ifbool{Bds}{\TLdung{B}}{\TLsai{B}}~\hspace*{-7pt}
\ifbool{Cds}{\TLdung{C}}{\TLsai{C}}~\hspace*{-7pt}
\ifbool{Dds}{\TLdung{D}}{\TLsai{D}}}
}%
}


\RenewEnviron{Solbook}[1]{%
\tikz{
\node[rounded corners,draw=\maunhan,font=\bfseries,text width=4cm,
align=center,minimum height=20pt]{\resizebox{3.9cm}{!}{Câu #1. \BODY}};
}%
}
\RenewEnviron{Solution}[1]{%
\tikz{\node[draw=\mycolor,thick,inner sep=3pt,text width=0.1\linewidth-4\fboxsep,minimum height=0.65cm,
rounded corners,fill=yellow!5,align=center](A){
{\textbf{#1}} -	{\textbf{\BODY}}
};
\path ($(A)+(0,-13pt)$);
}
}
\RenewEnviron{enumEX}[2][]{
\ifthenelse{\equal{#2}{1}}%
{%
\begin{enumerate}%[label*=\circlenum{\Alph*},itemsep=-1pt,topsep=0pt]%
\BODY%
\end{enumerate}%
}%
{\begin{multicols}{#2}
\begin{enumerate}%[label*=\circlenum{\Alph*},itemsep=-1pt,topsep=0pt]%
\BODY%
\end{enumerate}%
\end{multicols}}%
}
\RenewEnviron{listEX}[1][1]{
\ifthenelse{\equal{#1}{1}}%
{%
\begin{enumerate}%[label*=\circlenum{\Alph*},itemsep=-1pt,topsep=0pt]%
\BODY%
\end{enumerate}%
}%
{\begin{multicols}{#1}
\begin{enumerate}%[label*=\circlenum{\Alph*},itemsep=-1pt,topsep=0pt]%
\BODY%
\end{enumerate}%
\end{multicols}}%
}

%%%===========Tùy chỉnh đáp án lời giải đúng sai ==================%%%
%%%Old
%\def\itemch{\item}
%\newenvironment{itemchoice}{\begin{enumerate}[wide=0.65cm,leftmargin=0.65cm,label*=\protect{\alph*)},itemsep=-3pt,topsep=-4pt]}{\end{enumerate}}

%%%New
\newcounter{itemchoicecount}
\newif\ifitemchoicetrue
\newcommand{\itemchoiceanswers}{}

\newcommand{\itemch}{%
\stepcounter{itemchoicecount}%
\edef\currentitem{\arabic{itemchoicecount}}%
\expandafter\ifx\csname itemchoice@\currentitem\endcsname\relax
\item[\alph{itemchoicecount})] \textbf{Sai}. %
\else
\csname itemchoice@\currentitem\endcsname
\item[\alph{itemchoicecount})] \textbf{Đúng}. %
\fi
}

\newcommand{\processitemchoiceanswers}[1]{%
\def\do##1{\expandafter\@processone##1\@nil}%
\expandafter\docsvlist\expandafter{#1}%
}

\def\@processone#1#2\@nil{%
\if T#1\relax
\expandafter\global\expandafter\let\csname itemchoice@#2\endcsname\itemchoicetruetrue
\else
\expandafter\global\expandafter\let\csname itemchoice@#2\endcsname\relax
\fi
}

\newenvironment{itemchoice}[1][]{%
\setcounter{itemchoicecount}{0}%
\processitemchoiceanswers{#1}%
\begin{enumerate}[wide=0.65cm,leftmargin=0.65cm,label*=\protect{\alph*)},itemsep=-3pt,topsep=-4pt]%
}{%
\end{enumerate}%
}

%%%%==========Lệnh tạo ôly kẻ ngang==================%%%
\newcommand{\taoolyH}[2][\mycolor]{
\noindent
\begin{center}
\foreach \i in {1,2,...,#2}{%
\begin{tikzpicture}
\foreach \j in {0,1,2,3,4}{
\pgfmathsetmacro\t{\j*0.25}
\draw[#1!65,line width =0.5pt] (0,\t)--(18,\t);
\foreach \k in {0,1,...,18}{
\draw[#1!65,line width =0.5pt] (\k,0)--(\k,1);
}
}
\end{tikzpicture}\\[-1.1pt]
}
\end{center}
}
%%%%==========Lệnh tạo ôly vở==================%%%
\newcommand{\taooly}[2][\mycolor]{
\noindent
\begin{center}
\foreach \i in {1,2,...,#2}{%
\begin{tikzpicture}
\draw[#1!65,step=0.2,ultra thin] (0,0) grid +(18,1);
\draw[#1!95!black] (0,0) grid +(18,1);
\end{tikzpicture}\\[-1.1pt]
}
\end{center}
}





%%%=================Bảng đáp án====================%%%
%\def\bangdapan#1{
%	\begin{center}
%		{\bfseries\sffamily BẢNG ĐÁP ÁN TRẮC NGHIỆM}
%		\vspace*{-11pt}
%	\end{center}
%	
%	\begin{flushleft}
%		\input{Ans/#1}
%	\end{flushleft}
%}

%\newcommand{\bangdapanTF}[1]{
%	\begin{center}
%		\textbf{\textsf{BẢNG ĐÁP ÁN ĐÚNG SAI Đ/S}}
%	\end{center}
%	\begin{multicols}{4}%
%		\input{Ansbook/#1}
%	\end{multicols}%
%}

%\newcommand{\bangdapanSA}[1]{%
%	\begin{center}
%		{\sffamily\bfseries ĐÁP SỐ PHẦN TRẢ LỜI NGẮN}
%	\end{center}
%	\medskip
%	\begin{flushleft}
%		\begin{multicols}{4}%
%			\input{Ans/#1}
%		\end{multicols}%
%	\end{flushleft}
%}	

%\usepackage{intcalc}
%\newcounter{itemcounth}
%\newcommand{\bangdapan}[1]{%
%	\setcounter{itemcounth}{0}
%	\begin{center}
%		{\large \bfseries\sffamily BẢNG ĐÁP ÁN TRẮC NGHIỆM }
%		\medskip 
%	\end{center}
%	\begin{center}
%		\begin{minipage}{16cm}
%			\setcounter{itemcounth}{0}
%			\RenewEnviron{Solution}[1]{%
%				\addtocounter{itemcounth}{1}
%				\ifodd\intcalcDiv{\value{itemcounth}-1}{10}
%				\tikz{\path (0,0) node[draw=\mauphu,thick,inner sep=3pt,text width=1.2cm,minimum height=0.65cm,
%					rounded corners=3pt,outer sep=0pt,fill=\mycolor!5]{%
%						\textcolor{\maudam}{\textbf{##1}}\hfill 
%						\textcolor{\maudam}{\textbf{\BODY}}%
%					};
%				}\ignorespaces
%				\else
%				\tikz{\path (0,0) node[draw=\mycolor,thick,inner sep=3pt,text width=1.2cm,minimum height=0.65cm,
%					rounded corners=3pt,outer sep=0pt,fill=\mycolor!5]{%
%						\textcolor{\mycolor}{\textbf{##1}}\hfill 
%						\textcolor{\mycolor}{\textbf{\BODY}}%
%					};
%				}\ignorespaces
%				\fi
%				\ifthenelse{\equal{\intcalcMod{\value{itemcounth}}{10}}{0}}
%				{\par\noindent\ignorespaces}{\hspace*{-3pt}}
%			}
%			\noindent
%			\input{Ans/#1}
%		\end{minipage}
%	\end{center}%
%}
%
%\newcommand{\bangdapanTF}[1]{%
%	\begin{center}
%		\textbf{\large\textsf{BẢNG ĐÁP ÁN ĐÚNG SAI Đ/S}}
%	\end{center}
%	\noindent
%	\setcounter{itemcounth}{0}
%	\RenewEnviron{Solbook}[1]{%
%		\addtocounter{itemcounth}{1}%
%		\ifodd\intcalcDiv{\value{itemcounth}-1}{4}%
%		\tikz{\path (0,0) node[draw=\mauphu,thick,inner sep=2pt,text width=4.1cm,minimum height=0.65cm,
%			rounded corners=3pt,outer sep=0pt,fill=\mycolor!5]{%
%				\textcolor{\maudam}{\textbf{Câu~##1}} \hfill
%				\textcolor{\maudam}{\textbf{\BODY}}%
%			};
%		}\ignorespaces
%		\else%
%		\tikz{\path (0,0) node[draw=\mycolor,thick,inner sep=2pt,text width=4.1cm,minimum height=0.65cm,
%			rounded corners=3pt,outer sep=0pt,fill=\mycolor!5]{%
%				\textcolor{\mycolor}{\textbf{Câu~##1}}\hfill 
%				\textcolor{\mycolor}{\textbf{\BODY}}%
%			};
%		}\ignorespaces
%		\fi%
%	}
%	\noindent
%	\input{Ansbook/#1}
%}
%
%\newcommand{\bangdapanSA}[1]{%
%	\setcounter{itemcounth}{0}
%	\RenewEnviron{loigiaibt}[1]{%
%		\addtocounter{itemcounth}{1}%
%		\ifodd\intcalcDiv{\value{itemcounth}-1}{4}%
%		{\small{\textbf{\color{\maunhan!50!black}\faKey BT ##1}}}\hspace{0.1cm}
%		\noindent\tikz[baseline=(char.base)]
%		{\path (0,0) node[rounded corners,draw=\maunhan!50!black,text width=2.73cm,align=center,minimum height=0.65cm] (char){\BODY}%
%		}
%		\else%
%		{\small{\textbf{\color{\mauphu!50!black}\faKey BT ##1}}}\hspace{0.1cm}
%		\tikz[baseline=(char.base)]
%		{\path (0,0) node[rounded corners,draw=\mauphu!50!black,text width=2.73cm,align=center,minimum height=0.65cm] (char){\BODY}%
%		}
%		\fi%
%	}
%	\begin{center}
%		\textbf{\large\textsf{ĐÁP SỐ PHẦN TRẢ LỜI NGẮN}}
%	\end{center}
%	\noindent
%	\input{Ans/#1}
%}





